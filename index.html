<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Annotiertes Video</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            overflow: hidden; /* Prevent page scrolling */
            height: 100vh;
            width: 100vw;
        }

        .container {
            position: relative;
            height: 100vh;
            width: 100vw;
        }

        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: rgba(26, 26, 26, 0.95);
            color: white;
            overflow-y: auto; /* Only sidebar scrolls */
            padding: 20px;
            backdrop-filter: blur(5px);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar.visible {
            transform: translateX(0);
        }

        .annotation {
            margin-bottom: 20px;
            padding: 15px;
            border-left: 3px solid #4CAF50;
            background: rgba(42, 42, 42, 0.9);
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .annotation:hover {
            background: rgba(58, 58, 58, 0.9);
        }

        .annotation.active {
            border-left-color: #ff4444;
            background: rgba(58, 42, 42, 0.9);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
        }

        .timestamp {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .annotation.active .timestamp {
            color: #ff4444;
        }

        /* Collapsible styling */
        details {
            margin-bottom: 10px;
        }

        summary {
            cursor: pointer;
            padding: 5px 0;
            font-weight: bold;
            color: #888;
            list-style: none;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::before {
            content: "▶ ";
            display: inline-block;
            transform: rotate(0deg);
            transition: transform 0.2s;
        }

        details[open] summary::before {
            transform: rotate(90deg);
        }

        .original-text {
            font-style: italic;
            margin-bottom: 10px;
            color: #ccc;
            font-size: 0.95em;
        }

        .enhancement {
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .citations {
            font-size: 0.85em;
            color: #888;
            padding-top: 8px;
            border-top: 1px solid #444;
        }

        /* Debug console */
        .debug-console {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
        }

        .debug-console.visible {
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="video-container">
        <iframe allowfullscreen
                frameborder="0"
                id="video-iframe"
                src="https://www.youtube.com/embed/-wpnNhdADsE?enablejsapi=1">
        </iframe>
    </div>

    <div class="sidebar" id="sidebar">
        <!-- Annotationen werden hier dynamisch eingefügt -->
    </div>

    <div class="debug-console" id="debug-console">
        <div id="debug-output"></div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // Enhanced logging system
    const Logger = {
        logs: [],
        maxLogs: 50,
        debugMode: true, // Toggle this for production

        log: function (message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {timestamp, message, data};
            this.logs.push(logEntry);

            if (this.logs.length > this.maxLogs) {
                this.logs.shift();
            }

            if (this.debugMode) {
                console.log(`[${timestamp}] ${message}`, data || '');
                this.updateDebugConsole();
            }
        },

        updateDebugConsole: function () {
            const debugOutput = document.getElementById('debug-output');
            const console = document.getElementById('debug-console');

            if (this.debugMode) {
                console.classList.add('visible');
                debugOutput.innerHTML = this.logs
                    .slice(-10) // Show last 10 logs
                    .map(log => `<div>[${log.timestamp}] ${log.message}</div>`)
                    .join('');
                debugOutput.scrollTop = debugOutput.scrollHeight;
            }
        },

        toggle: function () {
            this.debugMode = !this.debugMode;
            const console = document.getElementById('debug-console');
            console.classList.toggle('visible', this.debugMode);
        }
    };

    // Press 'D' to toggle debug console
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'd') {
            Logger.toggle();
        }
    });

    // Your annotation data
    const raw = {
        "video_annotations": {
            "metadata": {
                "video_title": "Japan Lauf-Reise - Tag 24-26",
                "language": "Deutsch",
                "annotation_focus": "Philosophische und motivationale Inhaltsverbesserung"
            },
            "annotations": [
                {
                    "timestamp": "7:37",
                    "original_text": "ich habe jeden Tag die Entscheidung zu sagen bleibe ich liegen chill jetzt noch oder gehe ich raus und mach das was ich tun muss",
                    "annotation": "Dies berührt Sartres Konzept der radikalen Freiheit und Verantwortung. Jeder Moment präsentiert das, was Existentialisten 'die fundamentale Wahl' nennen.",
                    "enhancement": "Der Sprecher identifiziert das zentrale existentialistische Dilemma - was Sartre 'être-pour-soi' (Sein-für-sich) nannte. Diese täglich Wahl repräsentiert das, was Viktor Frankl 'die letzte menschliche Freiheit' nannte - die Fähigkeit, seine Haltung in jeder Situation zu wählen.",
                    "citations": ["Sartre, J.P. 'Das Sein und das Nichts' (1943)", "Frankl, V. 'Die Suche des Menschen nach Sinn' (1946)"],
                    "philosophical_depth": 8
                },
                {
                    "timestamp": "8:32",
                    "original_text": "ich weiß wie es sich anfühlt wenn man seine Arbeit verrichtet hat und dieses Zufriedenheitsgefühl",
                    "annotation": "Verweist auf das Konzept der 'Eudaimonia' - Erfüllung durch tugendhaftes Handeln statt hedonistische Freude.",
                    "enhancement": "Dies beschreibt das, was Aristoteles 'Eudaimonia' nannte - die tiefe Zufriedenheit, die aus der Verwirklichung des eigenen Potentials entsteht. Die moderne Psychologie validiert dies als 'intrinsische Motivation' (Deci & Ryans Selbstbestimmungstheorie).",
                    "citations": ["Aristoteles, 'Nikomachische Ethik'", "Deci, E.L. & Ryan, R.M. 'Selbstbestimmungstheorie' (1985)"],
                    "philosophical_depth": 7
                },
                {
                    "timestamp": "9:43",
                    "original_text": "es wird nie eine Abkürzung geben nie gewöhnt euch dran die Treppe zu nehmen",
                    "annotation": "Spiegelt stoische Philosophie über die Notwendigkeit des Kampfes für Charakterentwicklung wider.",
                    "enhancement": "Dies stimmt mit dem stoischen Prinzip überein, dass Hindernisse der Weg selbst sind. Marcus Aurelius schrieb: 'Das Hindernis für Handlung fördert Handlung. Was im Weg steht, wird zum Weg.' Moderne Forschung zu 'posttraumatischem Wachstum' stützt diese antike Weisheit.",
                    "citations": ["Marcus Aurelius, 'Selbstbetrachtungen'", "Tedeschi, R.G. & Calhoun, L.G. 'Posttraumatisches Wachstum' (2004)"],
                    "philosophical_depth": 9
                },
                {
                    "timestamp": "11:02",
                    "original_text": "es ist ein Naturgesetz dass wenn du Gas gibst und wirklich aus dem Herzen heraus 100% gibst",
                    "annotation": "Behauptet Naturgesetzes-Status für Anstrengung-Belohnung-Korrelation - benötigt Nuancierung.",
                    "enhancement": "Während Anstrengung oft mit Ergebnissen korreliert, vereinfacht die Bezeichnung als 'Naturgesetz' komplexe Systeme. Nassim Talebs Arbeit über Zufälligkeit und der 'Gerecht-Welt-Fehlschluss' in der Psychologie zeigen, dass diese Beziehung eher probabilistisch als deterministisch ist.",
                    "citations": ["Taleb, N.N. 'Der Schwarze Schwan' (2001)", "Lerner, M.J. 'Der Glaube an eine gerechte Welt' (1980)"],
                    "philosophical_depth": 6,
                    "correction": "Die Behauptung des Sprechers benötigt Abschwächung durch Anerkennung systemischer Faktoren und Zufälligkeit."
                },
                {
                    "timestamp": "13:50",
                    "original_text": "fokussiert dich in eurem Leben immer auf Kontinuität nicht auf die Perfektion",
                    "annotation": "Stellt Perfektionismus zugunsten konstanten Fortschritts in Frage - psychologisch validierter Ansatz.",
                    "enhancement": "Dies stimmt mit Forschung zu 'Implementierungsabsichten' und 'Gewohnheitsbildung' überein. Der Sprecher erfasst intuitiv das, was Brené Brown 'Perfektionismus als Feind des Fortschritts' nennt und was James Clear 'atomare Gewohnheiten' bezeichnet.",
                    "citations": ["Gollwitzer, P.M. 'Implementierungsabsichten' (1999)", "Clear, J. 'Die 1%-Methode' (2018)", "Brown, B. 'Die Gaben der Unperfektion' (2010)"],
                    "philosophical_depth": 8
                }
            ]
        }
    };

    function parseTimestamp(timestamp) {
        Logger.log(`Parsing timestamp: ${timestamp}`);
        const parts = timestamp.split(':');
        let seconds = 0;

        if (parts.length === 2) {
            seconds = parseInt(parts[0]) * 60 + parseInt(parts[1]);
        } else if (parts.length === 3) {
            seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }

        Logger.log(`Parsed to ${seconds} seconds`);
        return seconds;
    }

    const annotations = raw.video_annotations.annotations.map(({timestamp, ...rest}) => {
        return {
            ...rest,
            timestamp,
            timestampSeconds: parseTimestamp(timestamp)
        };
    });

    Logger.log(`Loaded ${annotations.length} annotations`);

    let player;
    let isPaused = false;
    let currentActiveAnnotations = [];
    const ANNOTATION_TOLERANCE = 30; // seconds

    // YouTube Player initialisieren
    function onYouTubeIframeAPIReady() {
        Logger.log('YouTube API ready, initializing player');
        player = new YT.Player('video-iframe', {
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        Logger.log('Player ready, setting up annotations');
        renderAnnotations();
        trackVideoProgress();
    }

    function onPlayerStateChange(event) {
        const states = {
            '-1': 'UNSTARTED',
            '0': 'ENDED',
            '1': 'PLAYING',
            '2': 'PAUSED',
            '3': 'BUFFERING',
            '5': 'CUED'
        };
        Logger.log(`Player state changed to: ${states[event.data] || event.data}`);
    }

    // Render annotations with collapsible structure
    function renderAnnotations() {
        const sidebar = document.getElementById('sidebar');
        sidebar.innerHTML = ''; // Clear existing content

        annotations.forEach((annotation, index) => {
            const div = document.createElement('div');
            div.className = 'annotation';
            div.setAttribute('data-time', annotation.timestampSeconds);
            div.setAttribute('data-index', index);

            // Create collapsible structure for inactive annotations
            div.innerHTML = `
                <div class="timestamp">${annotation.timestamp}</div>
                <details class="annotation-details">
                    <summary>Annotation anzeigen</summary>
                    <div class="original-text">"${annotation.original_text}"</div>
                    <div class="enhancement">${annotation.enhancement}</div>
                    <div class="citations">${annotation.citations.join(', ')}</div>
                </details>
            `;

            // Click handler für Zeitsprung
            div.addEventListener('click', (e) => {
                // Prevent navigation when clicking on details/summary
                if (e.target.tagName !== 'SUMMARY') {
                    Logger.log(`Seeking to timestamp: ${annotation.timestamp} (${annotation.timestampSeconds}s)`);
                    player.seekTo(annotation.timestampSeconds);
                }
            });

            sidebar.appendChild(div);
        });

        Logger.log('Annotations rendered');
    }

    // Video Progress tracking
    function trackVideoProgress() {
        setInterval(() => {
            if (player && player.getCurrentTime) {
                const currentTime = player.getCurrentTime();
                updateAnnotationVisibility(currentTime);
            }
        }, 1000);
    }

    // Update annotation visibility based on current video time
    function updateAnnotationVisibility(currentTime) {
        const annotationElements = document.querySelectorAll('.annotation');
        const sidebar = document.getElementById('sidebar');
        let hasActiveAnnotations = false;

        annotationElements.forEach(el => {
            const annotationTime = parseInt(el.getAttribute('data-time'));
            const details = el.querySelector('.annotation-details');

            const isActive = Math.abs(currentTime - annotationTime) < ANNOTATION_TOLERANCE;

            if (isActive) {
                el.classList.add('active');
                // Show full content for active annotations
                details.innerHTML = `
                    <div class="original-text">"${annotations[el.getAttribute('data-index')].original_text}"</div>
                    <div class="enhancement">${annotations[el.getAttribute('data-index')].enhancement}</div>
                    <div class="citations">${annotations[el.getAttribute('data-index')].citations.join(', ')}</div>
                `;
                hasActiveAnnotations = true;

                if (!currentActiveAnnotations.includes(annotationTime)) {
                    Logger.log(`Annotation activated at ${annotations[el.getAttribute('data-index')].timestamp}`);
                    currentActiveAnnotations.push(annotationTime);
                }
            } else {
                el.classList.remove('active');
                // Restore collapsible structure for inactive annotations
                details.innerHTML = `
                    <summary>Annotation anzeigen</summary>
                    <div class="original-text">"${annotations[el.getAttribute('data-index')].original_text}"</div>
                    <div class="enhancement">${annotations[el.getAttribute('data-index')].enhancement}</div>
                    <div class="citations">${annotations[el.getAttribute('data-index')].citations.join(', ')}</div>
                `;

                // Remove from active list
                const index = currentActiveAnnotations.indexOf(annotationTime);
                if (index > -1) {
                    currentActiveAnnotations.splice(index, 1);
                }
            }
        });

        // Show/hide sidebar based on active annotations
        if (hasActiveAnnotations && !sidebar.classList.contains('visible')) {
            Logger.log('Sidebar shown - active annotations found');
            sidebar.classList.add('visible');
        } else if (!hasActiveAnnotations && sidebar.classList.contains('visible')) {
            Logger.log('Sidebar hidden - no active annotations');
            sidebar.classList.remove('visible');
        }
    }

    // Sidebar hover = Video pausieren (only when visible)
    document.getElementById('sidebar').addEventListener('mouseenter', () => {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
            Logger.log('Video paused due to sidebar hover');
            player.pauseVideo();
            isPaused = true;
        }
    });

    document.getElementById('sidebar').addEventListener('mouseleave', () => {
        if (player && isPaused) {
            Logger.log('Video resumed after leaving sidebar');
            player.playVideo();
            isPaused = false;
        }
    });

    // Initialize logging
    Logger.log('Application initialized');
</script>
</body>
</html>